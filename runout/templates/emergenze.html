{% extends "base.html" %}

{% block title %}Emergenze - Runout{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>EMERGENZE</h2>
        <div class="info-bar">
            <span class="info-item">
                <strong>Data:</strong> {{ giorno }}
            </span>
            <span class="info-item">
                <strong>Ora:</strong> {{ ora }}
            </span>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-number">{{ risultati|length }}</div>
            <div class="stat-label">Totale Aule</div>
        </div>
        <div class="stat-card success">
            <div class="stat-number">{{ risultati|selectattr('errore', 'none')|list|length }}</div>
            <div class="stat-label">Classi piene</div>
        </div>
        <div class="stat-card error">
            <div class="stat-number">{{ risultati|selectattr('errore')|list|length }}</div>
            <div class="stat-label">Classi vuote</div>
        </div>
    </div>

    <div class="classi-grid">
        {% for risultato in risultati %}
         {# Provo a ricavare la CLASSE:
            - prima da risultato.risultato['classe']
            - altrimenti dal primo studente (se presente) -> studente['classe']
            - fallback: uso l'aula #}
         {% set classe = risultato.aula %}
         {% if risultato.risultato and risultato.risultato is mapping %}
             {% if risultato.risultato.get('classe') %}
                 {% set classe = risultato.risultato.get('classe') %}
             {% elif risultato.risultato.get('studenti') and (risultato.risultato.get('studenti')|length > 0) %}
                 {% set primo = risultato.risultato.get('studenti')[0] %}
                 {% if primo is mapping and primo.get('classe') %}
                     {% set classe = primo.get('classe') %}
                 {% endif %}
             {% endif %}
         {% endif %}
        <a href="{{ url_for('elencoStudenti', classe=classe) }}" class="classe-card-link">
        <div class="classe-card {% if risultato.errore %}error-card{% else %}success-card{% endif %}">
            <div class="classe-header">
                <h3 class="classe-nome">{{ risultato.aula }}</h3>
                {% if risultato.errore %}
                    <span class="status-badge error-badge">VUOTA</span>
                {% else %}
                    <span class="status-badge success-badge">PIENA</span>
                {% endif %}
            </div>
            
            {% if risultato.errore %}
                <div class="classe-content">
                    <p class="error-message">{{ risultato.errore }}</p>
                </div>
            {% else %}
                <div class="classe-content">
                    {% if risultato.risultato %}
                        {% if risultato.risultato is mapping %}
                            {% if risultato.risultato.get('studenti') %}
                                {% set studenti = risultato.risultato.studenti %}
                                <div class="studenti-count">
                                    <span class="count-number">{{ studenti|length }}</span>
                                    <span class="count-label">studenti</span>
                                </div>
                                {% if studenti|length > 0 %}
                                    <div class="studenti-list">
                                        {% for studente in studenti[:5] %}
                                            <div class="studente-item">
                                                {% if studente is mapping %}
                                                    {{ studente.get('nome', studente.get('cognome', 'N/A')) }}
                                                {% else %}
                                                    {{ studente }}
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                        {% if studenti|length > 5 %}
                                            <div class="studente-item more">+{{ studenti|length - 5 }} altri</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% elif risultato.risultato.get('classe') or risultato.risultato.get('aula') %}
                                <p class="info-message">Dati aula disponibili</p>
                                <pre class="data-preview">{{ risultato.risultato|tojson(indent=2) }}</pre>
                            {% else %}
                                <p class="empty-message">Nessuno studente presente</p>
                            {% endif %}
                        {% elif risultato.risultato is iterable and risultato.risultato is not string %}
                            <div class="studenti-count">
                                <span class="count-number">{{ risultato.risultato|length }}</span>
                                <span class="count-label">elementi</span>
                            </div>
                            <pre class="data-preview">{{ risultato.risultato|tojson(indent=2) }}</pre>
                        {% else %}
                            <pre class="data-preview">{{ risultato.risultato|tojson(indent=2) }}</pre>
                        {% endif %}
                    {% else %}
                        <p class="empty-message">Nessun dato disponibile</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endblock %}
