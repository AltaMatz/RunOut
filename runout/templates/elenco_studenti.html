{% extends "base.html" %}

{% block title %}Elenco Studenti - {{ classe }} - Runout{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>ELENCO STUDENTI</h2>
        <div class="info-bar">
            <span class="info-item">
                <strong>Classe:</strong> {{ classe }}
            </span>
        </div>
    </div>

    <div class="back-button-container">
        <a href="{{ url_for('emergenze') }}" class="back-button">
            â† Torna alle Emergenze
        </a>
    </div>

    {% if errore %}
        <div class="error-container">
            <div class="error-message-large">
                <strong>Errore:</strong> {{ errore }}
            </div>
        </div>
    {% else %}
        <div class="studenti-container">
            <div class="studenti-header">
                <div class="studenti-count-large">
                    <span class="count-number-large">{{ studenti|length }}</span>
                    <span class="count-label-large">studenti</span>
                </div>
            </div>

            {% if studenti|length > 0 %}
                <form id="presenze-form">
                    <div class="studenti-list-container">
                        {% for studente in studenti %}
                            {% set nome_studente = studente %}
                            {% if studente is mapping %}
                                {% if studente.get('cognome') and studente.get('nome') %}
                                    {% set nome_studente = studente.cognome + " " + studente.nome %}
                                {% elif studente.get('cognome') %}
                                    {% set nome_studente = studente.cognome %}
                                {% elif studente.get('nome') %}
                                    {% set nome_studente = studente.nome %}
                                {% else %}
                                    {% set nome_studente = studente|string %}
                                {% endif %}
                            {% endif %}
                            <div class="studente-card">
                                <div class="studente-info">
                                    <div class="studente-nome">{{ nome_studente }}</div>
                                    {% if studente is mapping %}
                                        {% if studente.get('matricola') %}
                                            <div class="studente-matricola">
                                                Matricola: {{ studente.matricola }}
                                            </div>
                                        {% endif %}
                                        {% if studente.get('classe') %}
                                            <div class="studente-classe">
                                                Classe: {{ studente.classe }}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="presenze-options">
                                    <label class="radio-option">
                                        <input type="radio" name="presenza_{{ loop.index0 }}" value="PRESENTE" data-studente="{{ nome_studente }}">
                                        <span class="radio-label presente">PRESENTE</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="presenza_{{ loop.index0 }}" value="ASSENTE" data-studente="{{ nome_studente }}">
                                        <span class="radio-label assente">ASSENTE</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="presenza_{{ loop.index0 }}" value="DISPERSO" data-studente="{{ nome_studente }}">
                                        <span class="radio-label disperso">DISPERSO</span>
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="save-button-container">
                        <button type="submit" class="save-button" id="save-btn">
                            ğŸ’¾ Salva Presenze
                        </button>
                        <div id="save-message" class="save-message"></div>
                    </div>
                </form>
            {% else %}
                <div class="empty-container">
                    <p class="empty-message-large">Nessuno studente presente in questa aula</p>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('presenze-form');
    const saveBtn = document.getElementById('save-btn');
    const saveMessage = document.getElementById('save-message');
    
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Raccogli tutti i dati delle presenze
            const presenze = {};
            const radioGroups = form.querySelectorAll('input[type="radio"]:checked');
            
            radioGroups.forEach(radio => {
                const nomeStudente = radio.getAttribute('data-studente');
                const stato = radio.value;
                presenze[nomeStudente] = stato;
            });
            
            // Prepara i dati da inviare
            const data = {
                classe: '{{ classe }}',
                presenze: presenze
            };
            
            // Disabilita il pulsante durante il salvataggio
            saveBtn.disabled = true;
            saveBtn.textContent = 'â³ Salvataggio...';
            saveMessage.textContent = '';
            saveMessage.className = 'save-message';
            
            try {
                const response = await fetch('{{ url_for("salva_presenze") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    saveMessage.textContent = 'âœ… ' + (result.message || 'Presenze salvate con successo!');
                    saveMessage.className = 'save-message success';
                } else {
                    saveMessage.textContent = 'âŒ ' + (result.error || 'Errore durante il salvataggio');
                    saveMessage.className = 'save-message error';
                }
            } catch (error) {
                saveMessage.textContent = 'âŒ Errore: ' + error.message;
                saveMessage.className = 'save-message error';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ Salva Presenze';
                
                // Nascondi il messaggio dopo 5 secondi
                setTimeout(() => {
                    saveMessage.textContent = '';
                    saveMessage.className = 'save-message';
                }, 5000);
            }
        });
    }
});
</script>
{% endblock %}

