{% extends "base.html" %}

{% block title %}Elenco Studenti - {{ aula }} - Runout{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>ELENCO STUDENTI</h2>
        <div class="info-bar">
            <span class="info-item">
                <strong>Aula:</strong> {{ aula }}
            </span>
        </div>
    </div>

    <div class="back-button-container">
        <a href="{{ url_for('emergenze') }}" class="back-button">
            ‚Üê Torna alle Emergenze
        </a>
    </div>

    {% if errore %}
        <div class="error-container">
            <div class="error-message-large">
                <strong>Errore:</strong> {{ errore }}
            </div>
        </div>
    {% else %}
        <div class="studenti-container">
            <div class="studenti-header">
                <div class="studenti-count-large">
                    <span class="count-number-large">{{ studenti|length }}</span>
                    <span class="count-label-large">studenti</span>
                </div>
            </div>

            {% if studenti|length > 0 %}
                <form id="presenze-form">
                    <div class="studenti-list-container">
                        <!-- Column Headers -->
                        <div class="studenti-row header-row">
                            <div class="studente-name-col">
                                <strong>Studente</strong>
                            </div>
                            <div class="presenze-col">
                                <strong>PRESENTE</strong>
                            </div>
                            <div class="presenze-col">
                                <strong>ASSENTE</strong>
                            </div>
                            <div class="presenze-col">
                                <strong>DISPERSO</strong>
                            </div>
                        </div>

                        {% for studente in studenti %}
                            {% set nome_studente = studente %}
                            {% if studente is mapping %}
                                {% if studente.get('cognome') and studente.get('nome') %}
                                    {% set nome_studente = studente.cognome + " " + studente.nome %}
                                {% elif studente.get('cognome') %}
                                    {% set nome_studente = studente.cognome %}
                                {% elif studente.get('nome') %}
                                    {% set nome_studente = studente.nome %}
                                {% else %}
                                    {% set nome_studente = studente|string %}
                                {% endif %}
                            {% endif %}
                            <div class="studenti-row data-row">
                                <div class="studente-name-col">
                                    <div class="studente-nome">{{ nome_studente }}</div>
                                    {% if studente is mapping %}
                                        {% if studente.get('matricola') %}
                                            <div class="studente-matricola">
                                                {{ studente.matricola }}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="presenze-col">
                                    <button type="button" class="presence-btn" data-status="PRESENTE" data-studente="{{ nome_studente }}" data-index="{{ loop.index0 }}">
                                        P
                                    </button>
                                </div>
                                <div class="presenze-col">
                                    <button type="button" class="presence-btn" data-status="ASSENTE" data-studente="{{ nome_studente }}" data-index="{{ loop.index0 }}">
                                        A
                                    </button>
                                </div>
                                <div class="presenze-col">
                                    <button type="button" class="presence-btn" data-status="DISPERSO" data-studente="{{ nome_studente }}" data-index="{{ loop.index0 }}">
                                        D
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="save-button-container">
                        <button type="submit" class="save-button" id="save-btn">
                            üíæ Salva Presenze
                        </button>
                        <div id="save-message" class="save-message"></div>
                    </div>
                </form>
            {% else %}
                <div class="empty-container">
                    <p class="empty-message-large">Nessuno studente presente in questa aula</p>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('presenze-form');
    const saveBtn = document.getElementById('save-btn');
    const saveMessage = document.getElementById('save-message');
    const presenceBtns = document.querySelectorAll('.presence-btn');
    
    // Track selections per student (by index)
    const selections = {};
    
    presenceBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const index = this.getAttribute('data-index');
            const status = this.getAttribute('data-status');
            const nomeStudente = this.getAttribute('data-studente');
            
            // Remove active class from all buttons for this student
            const studentBtns = document.querySelectorAll(`button[data-index="${index}"]`);
            studentBtns.forEach(b => b.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Store selection
            selections[index] = {
                studente: nomeStudente,
                status: status
            };
        });
    });
    
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Convert selections to presenze format
            const presenze = {};
            Object.values(selections).forEach(sel => {
                presenze[sel.studente] = sel.status;
            });
            
            // Prepara i dati da inviare
            const data = {
                classe: '{{ classe }}',
                presenze: presenze
            };
            
            // Disabilita il pulsante durante il salvataggio
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Salvataggio...';
            saveMessage.textContent = '';
            saveMessage.className = 'save-message';
            
            try {
                const response = await fetch('{{ url_for("salva_presenze") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    saveMessage.textContent = '‚úÖ ' + (result.message || 'Presenze salvate con successo!');
                    saveMessage.className = 'save-message success';
                } else {
                    saveMessage.textContent = '‚ùå ' + (result.error || 'Errore durante il salvataggio');
                    saveMessage.className = 'save-message error';
                }
            } catch (error) {
                saveMessage.textContent = '‚ùå Errore: ' + error.message;
                saveMessage.className = 'save-message error';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Salva Presenze';
                
                // Nascondi il messaggio dopo 5 secondi
                setTimeout(() => {
                    saveMessage.textContent = '';
                    saveMessage.className = 'save-message';
                }, 5000);
            }
        });
    }
});
</script>

<style>
.studenti-list-container {
    display: flex;
    flex-direction: column;
    gap: 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.studenti-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 0;
    padding: 12px;
    border-bottom: 1px solid #eee;
    align-items: center;
}

.studenti-row.header-row {
    background-color: #f5f5f5;
    font-weight: bold;
    border-bottom: 2px solid #ddd;
    padding: 16px 12px;
}

.studenti-row.data-row:last-child {
    border-bottom: none;
}

.studenti-row.data-row:hover {
    background-color: #fafafa;
}

.studente-name-col {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.studente-nome {
    font-weight: 500;
    color: #333;
}

.studente-matricola {
    font-size: 0.85em;
    color: #999;
}

.presenze-col {
    display: flex;
    justify-content: center;
}

.presence-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid #ccc;
    background-color: #f0f0f0;
    color: #666;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.presence-btn:hover {
    border-color: #999;
    transform: scale(1.05);
}

.presence-btn.active[data-status="PRESENTE"] {
    background-color: #4caf50;
    color: white;
    border-color: #45a049;
}

.presence-btn.active[data-status="ASSENTE"] {
    background-color: #ffc107;
    color: white;
    border-color: #ffb300;
}

.presence-btn.active[data-status="DISPERSO"] {
    background-color: #f44336;
    color: white;
    border-color: #da190b;
}
</style>

{% endblock %}

